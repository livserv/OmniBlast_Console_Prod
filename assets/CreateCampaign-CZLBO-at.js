import{r as i,j as e,M as K,B as g,d as O,f as H,k as J,u as Y,l as Q,D as P,m as X}from"../index.ChXpIm8i.js";import{M as Z}from"./MediaGrid-BNp8TO_l.js";import{T as ee}from"./TemplateDetails-DLBu8a0Q.js";import{u as se}from"./campaign-CU3HBK63.js";import{u as te}from"./integration-dt0Vcpzg.js";import{u as ae}from"./template-SlQ4jDtn.js";import"./TemplateStatusBadge-D8_LLKGq.js";const re=({isOpen:a,onClose:x,onSelect:f,fileType:j})=>{const[h,o]=i.useState(null),p=v=>{o(v)},c=()=>{h&&(f(h),x())};return e.jsx(K,{isOpen:a,onClose:x,title:"Select Media",size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsx(Z,{selectionMode:!0,showViewToggle:!0,showSearch:!0,fileType:j,onFileSelect:p})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(g,{variant:"default",onClick:x,children:"Cancel"}),e.jsx(g,{onClick:c,disabled:!h,children:"Select"})]})]})})},le=({onFileSelect:a,disabled:x})=>{const f=i.useRef(null),j=h=>{const o=h.target.files?.[0];if(!o)return;if(!o.name.endsWith(".csv")){alert("Please select a CSV file");return}const p=new FileReader;p.onload=c=>{const v=c.target?.result;a(v,o.name)},p.readAsText(o),h.target.value=""};return e.jsxs("div",{children:[e.jsxs(g,{variant:"default",onClick:()=>f.current?.click(),disabled:x,children:[e.jsx("span",{className:"mr-2",children:"⬆"}),"Upload CSV"]}),e.jsx("input",{ref:f,type:"file",accept:".csv",className:"hidden",onChange:j})]})},A=50,ie=({validation:a})=>{const[x,f]=i.useState(1),[j,h]=i.useState(!1),o=l=>a.errors.filter(y=>y.rowIndex===l),p=i.useMemo(()=>j?a.rows.filter(l=>o(l.rowIndex).some(N=>N.severity==="error")):a.rows,[a.rows,j]),c=Math.ceil(p.length/A),v=(x-1)*A,w=v+A,I=p.slice(v,w),r=()=>{f(l=>Math.max(1,l-1))},C=()=>{f(l=>Math.min(c,l+1))};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-6 p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-5 h-5 text-green-600",children:"✓"}),e.jsxs("span",{className:"text-sm font-medium",children:[a.validRows," Valid"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-5 h-5 text-red-600",children:"✗"}),e.jsxs("span",{className:"text-sm font-medium",children:[a.invalidRows," Invalid"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-5 h-5 text-yellow-600",children:"⚠"}),e.jsxs("span",{className:"text-sm font-medium",children:[a.warnings," Warnings"]})]}),e.jsx("div",{className:"ml-auto",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:j,onChange:l=>{h(l.target.checked),f(1)},className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),"Show only errors"]})})]}),a.errors.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500",children:"Row"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500",children:"Mobile"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500",children:"Name"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500",children:"Issues"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:I.map((l,y)=>{const N=o(l.rowIndex),T=N.some(b=>b.severity==="error"),k=N.some(b=>b.severity==="warning");return e.jsxs("tr",{className:O({"bg-red-50":T,"bg-yellow-50":!T&&k}),children:[e.jsx("td",{className:"px-4 py-2 text-sm",children:l.rowIndex}),e.jsx("td",{className:"px-4 py-2 text-sm",children:l.mobile}),e.jsxs("td",{className:"px-4 py-2 text-sm",children:[l.name||e.jsx("span",{className:"text-gray-400 italic",children:"-"}),!l.name&&e.jsx("span",{className:"inline-block w-4 h-4 ml-1 text-red-600",children:"!"})]}),e.jsx("td",{className:"px-4 py-2 text-sm",children:N.map((b,n)=>e.jsxs("div",{className:O("text-xs",{"text-red-600":b.severity==="error","text-yellow-600":b.severity==="warning"}),children:[b.field,": ",b.message]},n))})]},y)})})]})})}),c>1&&e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:["Showing ",v+1," to ",Math.min(w,p.length)," of ",p.length," rows"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{size:"sm",variant:"default",onClick:r,disabled:x===1,children:"Previous"}),e.jsxs("div",{className:"flex items-center px-3 text-sm text-gray-700",children:["Page ",x," of ",c]}),e.jsx(g,{size:"sm",variant:"default",onClick:C,disabled:x===c,children:"Next"})]})]})]})]})},z=a=>a>=1e6?`${(a/1e6).toFixed(1)}M`:a>=1e3?`${(a/1e3).toFixed(1)}K`:a.toLocaleString(),he=()=>{const a=H(),[x]=J(),{createCampaign:f,isLoading:j,error:h,clearError:o}=se(),{loadTemplates:p,templates:c}=ae(),{loadIntegrations:v,integrations:w}=te(),{user:I}=Y(),[r,C]=i.useState({name:"",templateId:x.get("templateId")||"",integrationId:"",scheduledAt:void 0}),[l,y]=i.useState("now"),[N,T]=i.useState(""),[k,b]=i.useState(""),[n,L]=i.useState(null),[u,$]=i.useState(null),[B,D]=i.useState(!1);i.useEffect(()=>()=>{o()},[o]);const t=i.useMemo(()=>c.find(s=>s._id===r.templateId||s.externalId===r.templateId),[r.templateId,c]);i.useEffect(()=>{p({status:"approved"}),v()},[]),i.useEffect(()=>{t?.integrationId&&r.integrationId!==t.integrationId&&C(s=>({...s,integrationId:t.integrationId}))},[t,w]);const q=i.useMemo(()=>{if(!t)return!1;const s=t.templateType;return s&&["IMAGE","VIDEO","DOCUMENT"].includes(s)},[t]),S=n?.rows?.length||0,F=I?.credits?.availableCredits||0,V=S>0&&S>F,R=i.useMemo(()=>{const s=[];if(r.name||s.push("Campaign name is required"),r.templateId||s.push("Template is required"),r.integrationId||s.push("Integration is required"),n?.isValid||s.push("Valid CSV data is required"),n?.rows?.length||s.push("At least one recipient is required"),q&&!u){const d=t.templateType;s.push(`Media file (${d?.toLowerCase()}) is required for this template type`)}return V&&s.push(`Insufficient credits. Required: ${S}, Available: ${F}`),s},[r,n,q,u,t,V,S,F]),U=i.useMemo(()=>c.filter(s=>s.status==="approved").map(s=>({label:`${s.displayName} (${s.type})`,value:s._id||s.externalId,integrationId:s.integrationId})),[c]),W=i.useMemo(()=>w.filter(s=>s.isActive).map(s=>({label:s.name,value:s.id})),[w]),_=async(s,d)=>{try{const m=t?.parameterCount??0,M=await(await fetch("/api/csv-campaigns/validate",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${X()}`},body:JSON.stringify({csvContent:s,parameterCount:m})})).json();console.log("CSV Validation Result:",M),L(M)}catch(m){console.error("CSV validation error:",m)}},G=async s=>{s.preventDefault(),o();const d={...r,scheduledAt:l==="later"&&N&&k?new Date(`${N}T${k}`):void 0};n?.isValid&&n.rows.length>0&&(d.csvData=n.rows.map(m=>({mobile:m.mobile,name:m.name,email:m.email,...Object.keys(m).filter(E=>E.startsWith("param")).reduce((E,M)=>({...E,[M]:m[M]}),{})}))),u&&(d.mediaFileId=u.id);try{await f(d),a("/campaigns")}catch(m){console.error("Failed to create campaign:",m)}};return e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Create Campaign"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Launch a new marketing campaign"})]}),e.jsx(g,{variant:"default",onClick:()=>a("/campaigns"),children:"Cancel"})]}),e.jsxs("form",{onSubmit:G,className:"bg-white rounded-lg border border-gray-200 p-6 space-y-6",children:[I?.credits&&e.jsxs("div",{className:"flex items-center justify-between bg-linear-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-5 h-5 text-blue-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-900",children:"Available Credits"}),e.jsx("p",{className:"text-2xl font-bold text-blue-700",children:z(I.credits.availableCredits)})]})]}),S>0&&e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Recipients: ",e.jsx("span",{className:"font-medium",children:z(S)})]}),e.jsx("p",{className:`text-sm font-medium ${V?"text-red-600":"text-green-600"}`,children:V?"Insufficient credits":"Credits available"})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Campaign Details"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Campaign Name *"}),e.jsx(Q,{value:r.name,onChange:s=>C({...r,name:s.value}),placeholder:"e.g., Summer Sale 2026",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Template *"}),e.jsx(P,{options:U,value:r.templateId,onChange:s=>{const d=c.find(m=>m._id===s.value);C({...r,templateId:s.value,integrationId:d?.integrationId||""})},placeholder:"Select template"}),t&&e.jsx("div",{className:"mt-4",children:e.jsx(ee,{template:t,variant:"horizontal"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Integration *"}),e.jsx(P,{options:W,value:r.integrationId,onChange:s=>C({...r,integrationId:s.value}),placeholder:"Select integration",disabled:!!r.templateId}),r.templateId&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Auto-selected based on template"})]})]})]}),r.templateId&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Bulk Recipients (CSV)"}),e.jsxs("div",{className:"space-y-4",children:[t&&t.parameterCount!==void 0&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-blue-600 font-semibold text-sm",children:t.parameterCount})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-blue-900",children:t.parameterCount===0?"No template parameters required":`Template requires ${t.parameterCount} ${t.parameterCount===1?"parameter":"parameters"}`}),t.parameterCount>0&&e.jsxs("p",{className:"text-xs text-blue-700 mt-1",children:["Your CSV must include columns: ",e.jsx("span",{className:"font-mono font-medium",children:"mobile"}),Array.from({length:t.parameterCount},(s,d)=>e.jsxs("span",{children:[", ",e.jsxs("span",{className:"font-mono font-medium",children:["param",d+1]})]},d)),". Optional: ",e.jsx("span",{className:"font-mono font-medium",children:"name"}),","," ",e.jsx("span",{className:"font-mono font-medium",children:"email"})]})]})]})}),n&&!n.isValid&&n.errors.some(s=>s.severity==="error")&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"shrink-0 w-8 h-8 bg-red-100 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-red-600 font-semibold text-xl",children:"!"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-red-900 mb-2",children:"CSV Validation Failed"}),e.jsx("ul",{className:"text-xs text-red-700 space-y-1",children:n.errors.filter(s=>s.severity==="error").map((s,d)=>e.jsx("li",{children:s.rowIndex===0?e.jsxs("span",{className:"font-medium",children:["Header Error: ",s.message]}):e.jsxs("span",{children:["Row ",s.rowIndex," - ",s.field,": ",s.message]})},d))})]})]})}),e.jsx(le,{onFileSelect:_,disabled:!r.templateId}),n&&e.jsx(ie,{validation:n})]})]}),t&&t.templateType&&["IMAGE","VIDEO","DOCUMENT"].includes(t.templateType)&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Media Selection"}),u?e.jsx("div",{className:"border border-gray-200 rounded-lg p-4 space-y-3",children:e.jsxs("div",{className:"flex items-start gap-4",children:[u.previewType==="image"?e.jsx("img",{src:`/api/files/${u.id}/download`,alt:u.originalName,className:"w-24 h-24 object-cover rounded border border-gray-200"}):e.jsx("div",{className:"w-24 h-24 bg-gray-100 rounded border border-gray-200 flex items-center justify-center",children:e.jsx("span",{className:"text-gray-400 text-sm",children:u.extension})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-gray-900",children:u.originalName}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:[(u.size/1024).toFixed(2)," KB • ",u.previewType]}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsx(g,{size:"sm",variant:"default",onClick:()=>D(!0),children:"Change"}),e.jsx(g,{size:"sm",variant:"default",onClick:()=>$(null),children:"Remove"})]})]})]})}):e.jsx(g,{onClick:()=>D(!0),variant:"default",children:"Select Media"})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Schedule"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"schedule",value:"now",checked:l==="now",onChange:s=>y(s.target.value),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"}),e.jsx("span",{className:"ml-2 text-sm text-gray-900",children:"Send immediately"})]}),e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"schedule",value:"later",checked:l==="later",onChange:s=>y(s.target.value),className:"w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500"}),e.jsx("span",{className:"ml-2 text-sm text-gray-900",children:"Schedule for later"})]}),l==="later"&&e.jsxs("div",{className:"ml-6 grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Date"}),e.jsx("input",{type:"date",value:N,onChange:s=>T(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Time"}),e.jsx("input",{type:"time",value:k,onChange:s=>b(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",required:!0})]})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[h&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"shrink-0 w-6 h-6 bg-red-100 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-red-600 font-semibold text-sm",children:"!"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-red-900 mb-1",children:"Error"}),e.jsx("p",{className:"text-xs text-red-700",children:h})]})]})}),R.length>0&&e.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"shrink-0 w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-orange-600 font-semibold text-sm",children:"!"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-orange-900 mb-2",children:"Please complete the following:"}),e.jsx("ul",{className:"text-xs text-orange-700 space-y-1 list-disc list-inside",children:R.map((s,d)=>e.jsx("li",{children:s},d))})]})]})}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4 border-t",children:[e.jsx(g,{type:"button",variant:"default",onClick:()=>a("/campaigns"),children:"Cancel"}),e.jsx(g,{type:"submit",disabled:j||R.length>0,children:j?"Creating...":"Create Campaign"})]})]})]}),e.jsx(re,{isOpen:B,onClose:()=>D(!1),onSelect:s=>$(s),fileType:t?.templateType?.toLowerCase()})]})};export{he as CreateCampaign,he as default};
//# sourceMappingURL=CreateCampaign-CZLBO-at.js.map
